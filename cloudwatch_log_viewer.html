<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudWatch Log Streamer</title>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1001.0.min.js"></script>
    <style>
        body {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace;
            margin: 0;
            padding: 20px;
            background-color: #1e1e1e;
            color: #d4d4d4;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            margin-bottom: 20px;
        }
        .input-group {
            margin-bottom: 15px;
        }
        input[type="text"] {
            padding: 8px;
            width: 300px;
            background-color: #2d2d2d;
            border: 1px solid #3d3d3d;
            color: #d4d4d4;
            border-radius: 4px;
            margin-right: 10px;
        }
        button {
            padding: 8px 16px;
            background-color: #0078d4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #106ebe;
        }
        .log-container {
            background-color: #2d2d2d;
            border-radius: 4px;
            padding: 10px;
            height: 600px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .log-entry {
            margin: 2px 0;
            padding: 2px 0;
            border-bottom: 1px solid #3d3d3d;
        }
        .timestamp {
            color: #569cd6;
        }
        .error { color: #f14c4c; }
        .warn { color: #cca700; }
        .info { color: #6a9955; }
        .debug { color: #9cdcfe; }
        .trace { color: #c586c0; }
        .status {
            color: #6a9955;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>CloudWatch Log Streamer</h1>
            <div class="input-group">
                <input type="text" id="logGroupName" placeholder="Log Group Name">
                <input type="text" id="identityPoolId" placeholder="Identity Pool ID">
                <button onclick="startStreaming()">Start Streaming</button>
                <button onclick="stopStreaming()">Stop Streaming</button>
            </div>
            <div id="status" class="status"></div>
        </div>
        <div id="logContainer" class="log-container"></div>
    </div>

    <script>
        // Constants matching Ruby implementation
        const POLL_INTERVAL = 2000; // 2 seconds
        const MAX_STREAMS = 10;
        const REGION = 'us-east-1';
        const LOOKBACK_MINUTES = 5;

        // State variables
        let isStreaming = false;
        let lastIngestedMap = {};
        let cloudWatchLogs;
        let cognitoClient;

        // Configure AWS SDK
        AWS.config.region = REGION;

        function updateStatus(message, isError = false) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.style.color = isError ? '#f14c4c' : '#6a9955';
        }

        async function setupCognitoClient(identityPoolId) {
            try {
                updateStatus('Setting up Cognito authentication...');
                
                // Initialize Cognito client
                cognitoClient = new AWS.CognitoIdentity();
                
                // Get identity ID
                const identityResponse = await cognitoClient.getId({
                    IdentityPoolId: identityPoolId,
                    Logins: {}
                }).promise();
                
                // Get credentials for the identity
                const credentialsResponse = await cognitoClient.getCredentialsForIdentity({
                    IdentityId: identityResponse.IdentityId,
                    Logins: {}
                }).promise();
                
                // Configure AWS credentials
                AWS.config.credentials = new AWS.Credentials({
                    accessKeyId: credentialsResponse.Credentials.AccessKeyId,
                    secretAccessKey: credentialsResponse.Credentials.SecretKey,
                    sessionToken: credentialsResponse.Credentials.SessionToken
                });
                
                // Initialize CloudWatch Logs client with new credentials
                cloudWatchLogs = new AWS.CloudWatchLogs();
                
                updateStatus('Cognito authentication successful');
                return true;
            } catch (error) {
                updateStatus(`Cognito authentication failed: ${error.message}`, true);
                return false;
            }
        }

        async function startStreaming() {
            const logGroupName = document.getElementById('logGroupName').value;
            const identityPoolId = document.getElementById('identityPoolId').value;

            if (!logGroupName || !identityPoolId) {
                updateStatus('Please enter both Log Group Name and Identity Pool ID', true);
                return;
            }

            // Setup Cognito authentication
            const authSuccess = await setupCognitoClient(identityPoolId);
            if (!authSuccess) {
                return;
            }

            // Verify log group exists
            try {
                const data = await cloudWatchLogs.describeLogGroups({
                    logGroupNamePrefix: logGroupName
                }).promise();
                
                const logGroupExists = data.logGroups.some(group => group.logGroupName === logGroupName);
                if (!logGroupExists) {
                    throw new Error(`Log group '${logGroupName}' does not exist.`);
                }
                
                isStreaming = true;
                updateStatus(`Connected to log group: ${logGroupName}`);
                streamLogs(logGroupName);
            } catch (error) {
                updateStatus(`Error: ${error.message}`, true);
            }
        }

        function stopStreaming() {
            isStreaming = false;
            updateStatus('Log streaming stopped.');
        }

        async function streamLogs(logGroupName) {
            if (!isStreaming) return;

            const startTime = Date.now() - (LOOKBACK_MINUTES * 60 * 1000);

            try {
                const data = await cloudWatchLogs.describeLogStreams({
                    logGroupName: logGroupName,
                    orderBy: 'LastEventTime',
                    descending: true,
                    limit: MAX_STREAMS
                }).promise();

                if (data.logStreams.length === 0) {
                    updateStatus(`No log streams found in log group ${logGroupName}`);
                    return;
                }

                const streamPromises = data.logStreams.map(async stream => {
                    const streamStartTime = lastIngestedMap[stream.logStreamName] || startTime;
                    
                    try {
                        const eventsData = await cloudWatchLogs.getLogEvents({
                            logGroupName: logGroupName,
                            logStreamName: stream.logStreamName,
                            startTime: streamStartTime + 1,
                            startFromHead: true
                        }).promise();

                        if (eventsData.events && eventsData.events.length > 0) {
                            eventsData.events.forEach(event => {
                                displayLog(event);
                            });
                            lastIngestedMap[stream.logStreamName] = eventsData.events[eventsData.events.length - 1].timestamp;
                        }
                    } catch (error) {
                        console.error(`Error fetching logs from stream ${stream.logStreamName}:`, error);
                    }
                });

                await Promise.all(streamPromises);

                if (isStreaming) {
                    setTimeout(() => streamLogs(logGroupName), POLL_INTERVAL);
                }
            } catch (error) {
                console.error('Error:', error);
                updateStatus(`Error: ${error.message}`, true);
                if (isStreaming) {
                    setTimeout(() => streamLogs(logGroupName), POLL_INTERVAL);
                }
            }
        }

        function parseLogMessage(message) {
            try {
                if (message.trim().startsWith('{') && message.trim().endsWith('}')) {
                    const parsed = JSON.parse(message);
                    return {
                        timestamp: parsed.timestamp || parsed.time || parsed['@timestamp'],
                        level: parsed.level || parsed.severity || parsed.log_level || 'INFO',
                        message: parsed.message || parsed.msg || message
                    };
                }
            } catch (e) {
                // Not valid JSON, continue with regex parsing
            }

            const levelMatch = message.match(/\b(ERROR|WARN(?:ING)?|INFO|DEBUG|TRACE)\b/i);
            return {
                timestamp: null,
                level: levelMatch ? levelMatch[1].toUpperCase() : 'INFO',
                message: message
            };
        }

        function displayLog(event) {
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';

            const timestamp = new Date(event.timestamp).toISOString();
            const parsed = parseLogMessage(event.message);
            
            logEntry.innerHTML = `
                <span class="timestamp">[${timestamp}]</span>
                <span class="${parsed.level.toLowerCase()}">${parsed.level.padEnd(7)}</span>
                ${parsed.message}
            `;

            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
    </script>
</body>
</html> 